<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŸå¸‚æŸ”æ€§èˆ±ï¼šåŠ¨æ€æ²‰æµ¸å¼å¯¼è§ˆ</title>
    
    <link rel="manifest" href="/manifest.json">
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe-ar/dist/aframe-ar.min.js"></script>

    <style>
        /* æ ·å¼ï¼šæ¨¡ä»¿ç‹¬ç«‹APPçš„æš—é»‘æ¨¡å¼è®¾è®¡ */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #1c1c1e; color: #ffffff; }
        .container { max-width: 600px; margin: auto; }
        h1 { color: #007aff; text-align: center; margin-bottom: 30px; }
        .status-box { background: #2c2c2e; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #ff9500; }
        .status-box p { margin: 5px 0; font-size: 14px; }
        #unlock-status { font-size: 18px; font-weight: bold; color: #ff3b30; text-align: center; padding: 10px; border-radius: 5px; }
        .unlocked { background-color: #34c759 !important; color: white !important; }
        button { width: 100%; padding: 15px; background-color: #007aff; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        button:disabled { background-color: #5ac8fa; cursor: not-allowed; opacity: 0.6; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        
        /* AR åœºæ™¯æ ·å¼ */
        #ar-scene-container { position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; display:none; }
        #exit-ar-btn { position: absolute; top: 20px; right: 20px; padding: 10px 15px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 5px; z-index: 10002; }
        
        /* AR åŠ è½½æç¤ºæ ·å¼ */
        #ar-loading-overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.9); 
            color: white; 
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 10001; 
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container" id="main-ui">
    <h1>åŸå¸‚æŸ”æ€§èˆ±ï¼šå®æ—¶å®šä½</h1>

    <div class="status-box">
        <p>æ‚¨çš„å®æ—¶ç»åº¦ï¼š<span id="user-lon">--</span></p>
        <p>æ‚¨çš„å®æ—¶çº¬åº¦ï¼š<span id="user-lat">--</span></p>
        <p>è·ç›®æ ‡è·ç¦»ï¼š<span id="distance">--</span> ç±³</p>
    </div>

    <div id="unlock-status">ğŸ›°ï¸ æ­£åœ¨è·å–æ‚¨çš„å®æ—¶ä½ç½®...</div>

    <button id="ar-button" disabled>è§£é” AR äº’åŠ¨ï¼ˆè·ç¦»ç›®æ ‡å¤ªè¿œï¼‰</button>
</div>

<div id="ar-scene-container">
    
    <div id="ar-loading-overlay">
        <h2>æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´å¹¶åŠ è½½ä»»åŠ¡æ¨¡å‹...</h2>
        <p style="margin-top: 15px;">è¯·å…è®¸æƒé™ã€‚å¦‚æœé•¿æ—¶é—´æ— ç”»é¢ï¼Œè¯·å°è¯•é‡æ–°ç‚¹å‡» AR æŒ‰é’®ã€‚</p>
    </div>
    
    <a-scene id="ar-scene" embedded arjs='sourceType: webcam;'>
        <a-assets>
            <a-asset-item id="robot-model" src="https://cdn.jsdelivr.net/gh/aframevr/aframe/examples/showcase/asset-management/models/robot.gltf"></a-asset-item>
            <a-asset-item id="cube-model" src="https://cdn.jsdelivr.net/gh/aframevr/aframe/examples/showcase/asset-management/models/cubes.gltf"></a-asset-item>
        </a-assets>
        </a-scene>
    <button id="exit-ar-btn">é€€å‡º AR</button>
</div>

<script>
    // ==========================================================
    // 1. ä»»åŠ¡æ•°æ®è®¾å®š (å·²è®¾ç½®ä¸ºæ‚¨ä¸Šæ¬¡çš„å®šä½æ•°æ®ï¼Œæ–¹ä¾¿ç›´æ¥è§£é”æµ‹è¯•)
    // ==========================================================
    const UNLOCK_DISTANCE_METERS = 50; // è§£é”è·ç¦»é˜ˆå€¼ï¼š50ç±³

    // å®šä¹‰æ‰€æœ‰ä»»åŠ¡ç‚¹
    const MISSIONS = [
        {
            id: 1,
            name: "å…¥å£å¯¼è§ˆæœºå™¨äºº",
            description: "ç‚¹å‡»æŸ¥çœ‹å•†åœˆæ´»åŠ¨ä»‹ç»ï¼",
            lat: 23.324856,     // ä»»åŠ¡ç‚¹ 1 (å’Œæ‚¨çš„ä½ç½®ç›¸åŒï¼Œç«‹å³è§£é”)
            lon: 112.707622,
            model_src: "#robot-model", 
            text_content: "ä»»åŠ¡ 1: æ¬¢è¿æ¥åˆ°æŸ”æ€§èˆ±ä½“éªŒï¼"
        },
        {
            id: 2,
            name: "å’–å•¡åº—ä¼˜æƒ åˆ¸",
            description: "æ­å–œè·å¾—ä¸€æ¯å…è´¹å’–å•¡åˆ¸ï¼",
            lat: 23.324857,    // ç•¥å¾®ä¿®æ”¹åæ ‡ï¼Œæ¨¡æ‹Ÿä¸‹ä¸€ä¸ªç‚¹
            lon: 112.707623,
            model_src: "#cube-model", 
            text_content: "ä»»åŠ¡ 2: é™æ—¶ä¼˜æƒ ï¼Œå’–å•¡ä¹°ä¸€é€ä¸€ï¼"
        }
    ];

    // è®¾ç½®å½“å‰è¦å¯»æ‰¾çš„ç›®æ ‡ç‚¹ä¸ºç¬¬ä¸€ä¸ªä»»åŠ¡
    let currentMissionIndex = 0;
    let currentTarget = MISSIONS[currentMissionIndex]; 

    // ==========================================================
    // 2. è·ç¦»è®¡ç®—å‡½æ•° (Haversine å…¬å¼)
    // ==========================================================
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; 
        const Ï†1 = lat1 * Math.PI / 180;
        const Ï†2 = lat2 * Math.PI / 180;
        const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
        const Î”Î» = (lon2 - lon1) * Math.PI / 180;

        const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                  Math.cos(Ï†1) * Math.cos(Ï†2) *
                  Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c;
    }

    // ==========================================================
    // 3. å®æ—¶å®šä½ä¸æ›´æ–°å‡½æ•° (ä¿æŒä¸å˜)
    // ==========================================================
    let watchId;

    function updateLocation(position) {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;

        document.getElementById('user-lat').textContent = userLat.toFixed(6);
        document.getElementById('user-lon').textContent = userLon.toFixed(6);

        const distance = calculateDistance(userLat, userLon, currentTarget.lat, currentTarget.lon);
        document.getElementById('distance').textContent = distance.toFixed(2);

        const unlockStatusElement = document.getElementById('unlock-status');
        const arButton = document.getElementById('ar-button');

        if (distance <= UNLOCK_DISTANCE_METERS) {
            unlockStatusElement.textContent = `ğŸ”“ ä»»åŠ¡ [${currentTarget.name}] å·²è§£é”ï¼`;
            unlockStatusElement.className = 'unlocked';
            arButton.textContent = `è¿›å…¥ AR æ²‰æµ¸å¼äº’åŠ¨ (${currentTarget.name})`;
            arButton.disabled = false;
        } else {
            unlockStatusElement.textContent = `ğŸš¨ ä»»åŠ¡ [${currentTarget.name}] å¤ªè¿œï¼Œè¿˜éœ€é è¿‘ ${Math.round(distance - UNLOCK_DISTANCE_METERS)} ç±³`;
            unlockStatusElement.className = '';
            arButton.textContent = `è§£é” AR äº’åŠ¨ï¼ˆè·ç¦»ç›®æ ‡å¤ªè¿œï¼‰`;
            arButton.disabled = true;
        }
    }

    // ... (handleLocationError å’Œ startGeolocation å‡½æ•°ä¿æŒä¸å˜) ...
    function startGeolocation() {
        if (!navigator.geolocation) {
            document.getElementById('unlock-status').textContent = 'âŒ æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒåœ°ç†ä½ç½®æœåŠ¡ã€‚';
            return;
        }

        watchId = navigator.geolocation.watchPosition(updateLocation, handleLocationError, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        });
    }

    function handleLocationError(error) {
        let message;
        switch(error.code) {
            case error.PERMISSION_DENIED:
                message = "âŒ è¯·æˆæƒåº”ç”¨ä½¿ç”¨æ‚¨çš„åœ°ç†ä½ç½®ä¿¡æ¯ã€‚";
                break;
            case error.POSITION_UNAVAILABLE:
                message = "ğŸ“¡ ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– GPSã€‚";
                break;
            case error.TIMEOUT:
                message = "â³ è·å–ä½ç½®è¶…æ—¶ï¼Œè¯·é‡è¯•ã€‚";
                break;
            default:
                message = "ä½ç½®è·å–å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚";
                break;
        }
        document.getElementById('unlock-status').textContent = message;
        console.error(error);
    }
    // ...

    // ==========================================================
    // 5.5 ä»»åŠ¡å®Œæˆé€»è¾‘ (æ–°å¢)
    // ==========================================================
    function completeMission() {
        alert(`æ­å–œæ‚¨å®Œæˆä»»åŠ¡ [${currentTarget.name}]ï¼`);
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªä»»åŠ¡
        if (currentMissionIndex < MISSIONS.length - 1) {
            // è¿˜æœ‰ä¸‹ä¸€ä¸ªä»»åŠ¡
            currentMissionIndex++; 
            currentTarget = MISSIONS[currentMissionIndex];
            
            // é€€å‡º ARï¼Œå›åˆ°ä¸»ç•Œé¢å¹¶è¿½è¸ªä¸‹ä¸€ä¸ªç›®æ ‡
            exitAR(false); 
        } else {
            // æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆ
            exitAR(true); 
            
            // ç»ˆæ€æ˜¾ç¤º
            const unlockStatusElement = document.getElementById('unlock-status');
            unlockStatusElement.textContent = 'ğŸ‰ æ­å–œï¼æ‚¨å·²å®Œæˆæ‰€æœ‰åŸå¸‚æŸ”æ€§èˆ±ä»»åŠ¡ï¼';
            unlockStatusElement.className = 'unlocked';
            document.getElementById('ar-button').style.display = 'none'; // éšè—æŒ‰é’®
        }
    }

    // ==========================================================
    // 5. AR åœºæ™¯æ§åˆ¶å‡½æ•° (å·²ä¿®æ”¹åŠ è½½æç¤ºå’Œæ¨¡å‹äº‹ä»¶)
    // ==========================================================
    function startAR() {
        const arContainer = document.getElementById('ar-scene-container');
        const mainUi = document.getElementById('main-ui');
        const arScene = document.getElementById('ar-scene'); 
        const loadingOverlay = document.getElementById('ar-loading-overlay'); // è·å–åŠ è½½å±‚
        
        mainUi.style.display = 'none';
        arContainer.style.display = 'block';

        if (watchId) { navigator.geolocation.clearWatch(watchId); }
        
        // æ­¥éª¤ 1: æ˜¾ç¤ºåŠ è½½æç¤º
        loadingOverlay.style.display = 'flex'; 

        // 1. æ¸…ç©ºæ—§å†…å®¹ (é™¤äº† a-assets)
        const children = Array.from(arScene.children);
        children.forEach(child => {
            if (child.tagName !== 'A-ASSETS') {
                arScene.removeChild(child);
            }
        });
        
        // 2. æ·»åŠ ç›¸æœºå®ä½“
        const camera = document.createElement('a-entity');
        camera.setAttribute('camera', '');
        arScene.appendChild(camera);

        // 3. æ·»åŠ åŠ¨æ€æ¨¡å‹
        const model = document.createElement('a-gltf-model');
        model.setAttribute('src', currentTarget.model_src);
        model.setAttribute('position', '0 0 -3'); // è°ƒæ•´ä½ç½®
        model.setAttribute('scale', '0.5 0.5 0.5'); 
        model.setAttribute('rotation', '0 0 0');
        arScene.appendChild(model);
        
        // 4. æ·»åŠ åŠ¨æ€æ–‡æœ¬
        const text = document.createElement('a-text');
        text.setAttribute('value', currentTarget.text_content);
        text.setAttribute('position', '-0.7 1.5 -3');
        text.setAttribute('color', '#FFC65D');
        text.setAttribute('width', '2');
        arScene.appendChild(text);
        
        // 5. æ·»åŠ æ¨¡å‹ç‚¹å‡»äº‹ä»¶ (è§¦å‘ä»»åŠ¡å®Œæˆ)
        model.addEventListener('click', completeMission);
        
        // 6. ç›‘å¬åŠ è½½å®Œæˆäº‹ä»¶å¹¶éšè—æç¤º
        arScene.addEventListener('loaded', function () {
            // åœ¨æ‰€æœ‰æ¨¡å‹å’Œèµ„æºåŠ è½½å®Œæˆåï¼Œéšè—åŠ è½½æç¤º
            loadingOverlay.style.display = 'none';
        });
    }

    function exitAR(finished = false) {
        const arContainer = document.getElementById('ar-scene-container');
        const mainUi = document.getElementById('main-ui');

        arContainer.style.display = 'none';
        mainUi.style.display = 'block';

        if (finished === false) {
            // å¦‚æœä»»åŠ¡æœªå®Œæˆ (åªæ˜¯æ™®é€šé€€å‡º AR)ï¼Œåˆ™é‡æ–°å¯åŠ¨ LBS è¿½è¸ªä¸‹ä¸€ä¸ªç›®æ ‡
            startGeolocation(); 
        }
        // å¦‚æœä»»åŠ¡å®Œæˆäº† (finished = true)ï¼Œåˆ™ä¸é‡å¯å®šä½ï¼Œä¿æŒåœ¨ç»ˆæ€ç•Œé¢
    }


    // ==========================================================
    // 6. äº‹ä»¶ç›‘å¬å’Œå¯åŠ¨
    // ==========================================================

    window.onload = startGeolocation;

    document.getElementById('ar-button').addEventListener('click', startAR);
    document.getElementById('exit-ar-btn').addEventListener('click', function() {
        // é€€å‡ºæŒ‰é’®é»˜è®¤ä¸ºæ™®é€šé€€å‡º
        exitAR(false); 
    });
</script>

</body>
</html>
