<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŸå¸‚æŸ”æ€§èˆ±ï¼šLBS + AR æ²‰æµ¸å¼å¯¼è§ˆ</title>
    
    <link rel="manifest" href="/manifest.json">
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe-ar/dist/aframe-ar.min.js"></script>

    <style>
        /* å¼•å…¥è‡ªå®šä¹‰å­—ä½“ */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        
        /* åŸºç¡€æ ·å¼ï¼šMVP 6.0 æ´ç™½ä¸»é¢˜è®¾è®¡ */
        body { 
            font-family: 'Roboto', sans-serif; 
            margin: 0; 
            padding: 0;
            background-color: #f5f5f7; /* æ´ç™½èƒŒæ™¯ */
            color: #333333; /* æ·±ç°æ–‡æœ¬ */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container { 
            width: 90%; 
            max-width: 500px; 
            margin-top: 5vh; 
            padding: 0; 
        }
        
        /* æ ‡é¢˜æ ·å¼ï¼šä½¿ç”¨å“ç‰Œè“ */
        h1 { 
            color: #007aff; /* å“ç‰Œè“ */
            text-align: center; 
            margin-bottom: 30px; 
            font-size: 2.2em;
            font-weight: 700;
            text-shadow: 0 0 5px rgba(0, 122, 255, 0.2); 
        }
        
        /* çŠ¶æ€æ¡†æ ·å¼ï¼šå¡ç‰‡å¼è®¾è®¡ */
        .status-box { 
            background: #ffffff; /* çº¯ç™½èƒŒæ™¯ */
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
            border: 1px solid #e0e0e0; /* æµ…ç°è‰²è¾¹æ¡† */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); 
        }
        .status-box p { 
            margin: 8px 0; 
            font-size: 15px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-box span {
            font-weight: bold;
            color: #007aff; /* çªå‡ºæ•°æ®æ˜¾ç¤º */
        }

        /* ä»»åŠ¡çŠ¶æ€æ ·å¼ */
        #unlock-status { 
            font-size: 1.1em; 
            font-weight: bold; 
            text-align: center; 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 25px;
            background-color: #ffe5e5; /* è­¦å‘Šè‰²èƒŒæ™¯ */
            color: #e60000; /* è­¦å‘Šè‰²æ–‡å­— */
        }
        .unlocked { 
            background-color: #e0f8e0 !important; /* è§£é”æˆåŠŸèƒŒæ™¯ */
            color: #008000 !important; /* æˆåŠŸè‰²æ–‡å­— */
            box-shadow: 0 0 10px rgba(0, 128, 0, 0.3); 
            animation: pulse 1s infinite alternate; 
        }
        
        /* æŒ‰é’®æ ·å¼ï¼šæ‰å¹³åŒ–è®¾è®¡ */
        button { 
            width: 100%; 
            padding: 16px; 
            background-color: #007aff; 
            color: #ffffff; 
            border: none; 
            border-radius: 10px; 
            font-size: 1.1em; 
            font-weight: bold;
            cursor: pointer; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3);
        }
        button:disabled { 
            background-color: #cccccc; 
            cursor: not-allowed; 
            opacity: 0.8;
            box-shadow: none;
        }
        button:hover:not(:disabled) { 
            background-color: #005bb5; 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.5);
        }
        
        /* å…³é”®å¸§åŠ¨ç”» */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.01); opacity: 0.95; }
        }

        /* AR åœºæ™¯å’ŒåŠ è½½æç¤ºæ ·å¼ */
        #ar-scene-container { position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; display:none; }
        #exit-ar-btn { 
            position: absolute; 
            top: 40px; 
            left: 20px; 
            padding: 10px 15px; 
            background: rgba(255, 69, 0, 0.8); 
            color: white; 
            border: none; 
            border-radius: 5px; 
            z-index: 10002;
            width: auto;
        }
        
        #ar-loading-overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(255,255,255,0.9); 
            color: #333333; 
            display: none; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 10001; 
            text-align: center;
        }
        #reload-ar-btn {
            background-color: #ff4500;
            width: auto;
            padding: 10px 20px;
        }

        /* å¥–åŠ±å¡ç‰‡æ ·å¼ (é€‚åº”äº®è‰²ä¸»é¢˜) */
        #reward-card-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 10003;
        }
        #reward-card {
            background: #ffffff; 
            color: #333333;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 350px;
            text-align: center;
            border: 2px solid #007aff;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        #close-reward-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2em;
            cursor: pointer;
            color: #cccccc; 
        }
        .reward-content {
            margin: 20px 0;
            padding: 15px;
            background: #f0f0f5; 
            border-radius: 10px;
        }
        .coupon-code {
            margin-top: 15px;
            border-top: 1px dashed #007aff;
            padding-top: 10px;
        }
        #reward-code {
            font-size: 1.5em;
            font-weight: bold;
            color: #e60000; 
            margin: 5px 0 0;
        }
        #reward-action-btn {
            display: block;
            margin-top: 20px;
            padding: 12px;
            background-color: #34c759;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #reward-action-btn:hover {
            background-color: #2b9942;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

<div class="container" id="main-ui">
    <h1>åŸå¸‚æŸ”æ€§èˆ±ï¼šå®æ—¶å®šä½</h1>

    <div class="status-box">
        <p>æ‚¨çš„å®æ—¶ç»åº¦ï¼š<span id="user-lon">--</span></p>
        <p>æ‚¨çš„å®æ—¶çº¬åº¦ï¼š<span id="user-lat">--</span></p>
        <p>è·ç›®æ ‡è·ç¦»ï¼š<span id="distance">--</span> ç±³</p>
    </div>

    <div id="unlock-status">ğŸ›°ï¸ æ­£åœ¨è·å–æ‚¨çš„å®æ—¶ä½ç½®...</div>

    <button id="ar-button" disabled>è§£é” AR äº’åŠ¨ï¼ˆè·ç¦»ç›®æ ‡å¤ªè¿œï¼‰</button>
</div>

<div id="ar-scene-container">
    
    <div id="ar-loading-overlay">
        <h2>æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´å¹¶åŠ è½½ä»»åŠ¡æ¨¡å‹...</h2>
        <p style="margin-top: 15px;">è¯·å…è®¸æƒé™ã€‚å¦‚æœé•¿æ—¶é—´æ— ç”»é¢ï¼Œè¯·å°è¯•é‡æ–°ç‚¹å‡» AR æŒ‰é’®ã€‚</p>
    </div>
    
    <a-scene id="ar-scene" embedded arjs='sourceType: webcam;'>
        <a-assets>
            <a-asset-item id="robot-model" src="https://cdn.jsdelivr.net/gh/aframevr/aframe/examples/showcase/asset-management/models/robot.gltf"></a-asset-item>
            <a-asset-item id="cube-model" src="https://cdn.jsdelivr.net/gh/aframevr/aframe/examples/showcase/asset-management/models/cubes.gltf"></a-asset-item>
        </a-assets>
    </a-scene>
    <button id="exit-ar-btn">é€€å‡º AR</button>
</div>

<div id="reward-card-overlay">
    <div id="reward-card">
        <span id="close-reward-btn">&times;</span>
        <h2>ğŸ‰ ä»»åŠ¡å®Œæˆï¼è·å¾—å¥–åŠ±ï¼</h2>
        <div class="reward-content">
            <h3 id="reward-name">ä»»åŠ¡å¥–åŠ±ï¼š</h3>
            <p id="reward-description">æ­å–œæ‚¨å®Œæˆæ‰€æœ‰ä»»åŠ¡ï¼</p>
            <div class="coupon-code">
                <p>ä¸“å±å…‘æ¢ç ï¼š</p>
                <p id="reward-code">FLEX-873-ARX</p>
            </div>
        </div>
        <a id="reward-action-btn" href="#" target="_blank">ç«‹å³æŸ¥çœ‹/å…‘æ¢</a>
    </div>
</div>

<script>
    // ==========================================================
    // 1. ä»»åŠ¡æ•°æ®è®¾å®š (ç¡¬ç¼–ç ç‰ˆæœ¬ - ä½¿ç”¨æˆåŠŸçš„æ—§é€»è¾‘)
    // ==========================================================
    const UNLOCK_DISTANCE_METERS = 50; 
    const MISSIONS = [
        {
            id: 1,
            name: "å…¥å£å¯¼è§ˆæœºå™¨äºº",
            description: "ç‚¹å‡»æŸ¥çœ‹å•†åœˆæ´»åŠ¨ä»‹ç»ï¼",
            // ç¡®ä¿è¿™äº›åæ ‡åœ¨æ‚¨å½“å‰æµ‹è¯•çš„é™„è¿‘ï¼Œä»¥è§¦å‘è§£é”
            lat: 23.324856,     
            lon: 112.707622,
            model_src: "#robot-model", 
            text_content: "ä»»åŠ¡ 1: æ¬¢è¿æ¥åˆ°æŸ”æ€§èˆ±ä½“éªŒï¼"
        },
        {
            id: 2,
            name: "å’–å•¡åº—ä¼˜æƒ åˆ¸",
            description: "æ­å–œè·å¾—ä¸€æ¯å…è´¹å’–å•¡åˆ¸ï¼",
            lat: 23.324857,    
            lon: 112.707623,
            model_src: "#cube-model", 
            text_content: "ä»»åŠ¡ 2: é™æ—¶ä¼˜æƒ ï¼Œå’–å•¡ä¹°ä¸€é€ä¸€ï¼"
        }
    ];
    let currentMissionIndex = 0;
    let currentTarget = MISSIONS[currentMissionIndex]; 


    // åŒæ­¥åˆå§‹åŒ–å‡½æ•°
    function initializeMissions() {
        if (MISSIONS.length === 0) {
            document.getElementById('unlock-status').textContent = 'âŒ ä»»åŠ¡æ•°æ®ä¸ºç©ºï¼Œæ— æ³•å¯åŠ¨ã€‚';
            return false;
        }
        document.getElementById('unlock-status').textContent = 'ğŸ›°ï¸ æ­£åœ¨è·å–æ‚¨çš„å®æ—¶ä½ç½®...';
        return true;
    }


    // ==========================================================
    // 2. è·ç¦»è®¡ç®—å‡½æ•° (Haversine å…¬å¼)
    // ==========================================================
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; 
        const Ï†1 = lat1 * Math.PI / 180;
        const Ï†2 = lat2 * Math.PI / 180;
        const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
        const Î”Î» = (lon2 - lon1) * Math.PI / 180;

        const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                  Math.cos(Ï†1) * Math.cos(Ï†2) *
                  Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c;
    }

    // ==========================================================
    // 3. å®æ—¶å®šä½ä¸æ›´æ–°å‡½æ•°
    // ==========================================================
    let watchId;

    function updateLocation(position) {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;

        document.getElementById('user-lat').textContent = userLat.toFixed(6);
        document.getElementById('user-lon').textContent = userLon.toFixed(6);

        if (!currentTarget) return;

        const distance = calculateDistance(userLat, userLon, currentTarget.lat, currentTarget.lon);
        document.getElementById('distance').textContent = distance.toFixed(2);

        const unlockStatusElement = document.getElementById('unlock-status');
        const arButton = document.getElementById('ar-button');

        if (distance <= UNLOCK_DISTANCE_METERS) {
            unlockStatusElement.textContent = `ğŸ”“ ä»»åŠ¡ [${currentTarget.name}] å·²è§£é”ï¼`;
            unlockStatusElement.className = 'unlocked';
            arButton.textContent = `è¿›å…¥ AR æ²‰æµ¸å¼äº’åŠ¨ (${currentTarget.name})`;
            arButton.disabled = false;
        } else {
            unlockStatusElement.textContent = `ğŸš¨ ä»»åŠ¡ [${currentTarget.name}] å¤ªè¿œï¼Œè¿˜éœ€é è¿‘ ${Math.round(distance - UNLOCK_DISTANCE_METERS)} ç±³`;
            unlockStatusElement.className = '';
            arButton.textContent = `è§£é” AR äº’åŠ¨ï¼ˆè·ç¦»ç›®æ ‡å¤ªè¿œï¼‰`;
            arButton.disabled = true;
        }
    }

    function startGeolocation() {
        if (!navigator.geolocation) {
            document.getElementById('unlock-status').textContent = 'âŒ æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒåœ°ç†ä½ç½®æœåŠ¡ã€‚';
            return;
        }

        // **å®šä½é€Ÿåº¦ä¼˜åŒ–ï¼šç§»é™¤ enableHighAccuracy: true ä»¥åŠ é€Ÿé¦–æ¬¡å®šä½**
        watchId = navigator.geolocation.watchPosition(updateLocation, handleLocationError, {
            timeout: 5000,
            maximumAge: 0
        });
    }

    function handleLocationError(error) {
        let message;
        switch(error.code) {
            case error.PERMISSION_DENIED:
                message = "âŒ è¯·æˆæƒåº”ç”¨ä½¿ç”¨æ‚¨çš„åœ°ç†ä½ç½®ä¿¡æ¯ã€‚";
                break;
            case error.POSITION_UNAVAILABLE:
                message = "ğŸ“¡ ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– GPSã€‚";
                break;
            case error.TIMEOUT:
                message = "â³ è·å–ä½ç½®è¶…æ—¶ï¼Œè¯·é‡è¯•ã€‚";
                break;
            default:
                message = "ä½ç½®è·å–å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚";
                break;
        }
        document.getElementById('unlock-status').textContent = message;
        console.error(error);
    }
    
    // ==========================================================
    // 5.6 å¥–åŠ±å¡ç‰‡æ˜¾ç¤ºå‡½æ•° 
    // ==========================================================
    function showRewardCard(message, taskName) {
        document.getElementById('reward-name').textContent = `ä»»åŠ¡ï¼š${taskName}`;
        document.getElementById('reward-description').textContent = message;
        
        const randomCode = 'FLEX-' + Math.floor(Math.random() * 900) + 100 + '-ARX';
        document.getElementById('reward-code').textContent = randomCode;
        
        document.getElementById('reward-card-overlay').style.display = 'flex';
    }

    // ==========================================================
    // 5.5 ä»»åŠ¡å®Œæˆé€»è¾‘ 
    // ==========================================================
    function completeMission(event) {
        const model = event.target;
        
        // 1. è§¦å‘æ¨¡å‹æ¶ˆå¤±/é—ªçƒåŠ¨ç”»
        model.setAttribute('animation__out', {
            property: 'scale',
            to: '0 0 0', 
            dur: 500,    
            easing: 'easeInQuad'
        });

        // 2. æ˜¾ç¤ºå¥–åŠ±å¡ç‰‡ 
        showRewardCard(currentTarget.description, currentTarget.name);

        // 3. ç­‰å¾…åŠ¨ç”»å®Œæˆåï¼Œæ‰§è¡Œä»»åŠ¡åˆ‡æ¢
        setTimeout(() => {
            
            if (currentMissionIndex < MISSIONS.length - 1) {
                currentMissionIndex++; 
                currentTarget = MISSIONS[currentMissionIndex];
            } else {
                exitAR(true); // ç»ˆæ€é€€å‡º AR
                
                const unlockStatusElement = document.getElementById('unlock-status');
                unlockStatusElement.textContent = 'ğŸ‰ æ­å–œï¼æ‚¨å·²å®Œæˆæ‰€æœ‰åŸå¸‚æŸ”æ€§èˆ±ä»»åŠ¡ï¼';
                unlockStatusElement.className = 'unlocked';
                document.getElementById('ar-button').style.display = 'none';
            }
        }, 600); 
    }

    // ==========================================================
    // 5. AR åœºæ™¯æ§åˆ¶å‡½æ•° 
    // ==========================================================
    function startAR() {
        const arContainer = document.getElementById('ar-scene-container');
        const mainUi = document.getElementById('main-ui');
        const arScene = document.getElementById('ar-scene'); 
        const loadingOverlay = document.getElementById('ar-loading-overlay'); 
        
        if (!currentTarget) {
            document.getElementById('unlock-status').textContent = 'âš ï¸ ä»»åŠ¡ç›®æ ‡æœªå°±ç»ªï¼Œè¯·é‡è¯•ã€‚';
            return;
        }

        mainUi.style.display = 'none';
        arContainer.style.display = 'block';

        if (watchId) { navigator.geolocation.clearWatch(watchId); }
        
        // æ­¥éª¤ 1: æ˜¾ç¤ºåŠ è½½æç¤º
        loadingOverlay.style.display = 'flex'; 
        loadingOverlay.innerHTML = '<h2>æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´å¹¶åŠ è½½ä»»åŠ¡æ¨¡å‹...</h2><p style="margin-top: 15px;">è¯·å…è®¸æƒé™ã€‚å¦‚æœé•¿æ—¶é—´æ— ç”»é¢ï¼Œè¯·å°è¯•é‡æ–°ç‚¹å‡» AR æŒ‰é’®ã€‚</p>';


        // ã€åŸç”Ÿæ‘„åƒå¤´æƒé™è¯·æ±‚ã€‘
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function(stream) {
                    stream.getTracks().forEach(track => track.stop());
                    
                    // --- AR åœºæ™¯æ„å»ºé€»è¾‘ ---
                    const children = Array.from(arScene.children);
                    children.forEach(child => {
                        if (child.tagName !== 'A-ASSETS') {
                            arScene.removeChild(child);
                        }
                    });
                    
                    const camera = document.createElement('a-entity');
                    camera.setAttribute('camera', '');
                    arScene.appendChild(camera);

                    const model = document.createElement('a-gltf-model');
                    model.setAttribute('src', currentTarget.model_src);
                    model.setAttribute('position', '0 0 -3'); 
                    model.setAttribute('scale', '0.5 0.5 0.5'); 
                    model.setAttribute('rotation', '0 0 0');
                    arScene.appendChild(model);
                    
                    const text = document.createElement('a-text');
                    text.setAttribute('value', currentTarget.text_content);
                    text.setAttribute('position', '-0.7 1.5 -3');
                    text.setAttribute('color', '#007aff'); 
                    text.setAttribute('width', '2');
                    arScene.appendChild(text);
                    
                    model.addEventListener('click', completeMission);
                    
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 1000); 

                })
                .catch(function(err) {
                    // æƒé™å¤±è´¥æˆ–æµè§ˆå™¨æ— æ³•è®¿é—®æ‘„åƒå¤´
                    loadingOverlay.innerHTML = '<h2>âŒ æ‘„åƒå¤´æƒé™è·å–å¤±è´¥ï¼</h2><p>è¯·æ£€æŸ¥ç³»ç»Ÿè®¾ç½®ä¸­æµè§ˆå™¨å¯¹æ‘„åƒå¤´å’Œè¿åŠ¨ä¼ æ„Ÿå™¨çš„æˆæƒã€‚</p><button id="reload-ar-btn" style="margin-top:20px;">é‡æ–°å°è¯•</button>';
                    document.getElementById('reload-ar-btn').addEventListener('click', startAR);
                });
        } else {
            loadingOverlay.innerHTML = '<h2>âŒ è®¾å¤‡ä¸æ”¯æŒ Web ARã€‚</h2><p>è¯·ä½¿ç”¨æœ€æ–°ç‰ˆ Chrome æˆ– Safari æµè§ˆå™¨ã€‚</p>';
        }
    }

    function exitAR(finished = false) {
        const arContainer = document.getElementById('ar-scene-container');
        const mainUi = document.getElementById('main-ui');

        arContainer.style.display = 'none';
        mainUi.style.display = 'block';

        if (finished === false) {
            startGeolocation(); 
        }
    }


    // ==========================================================
    // 6. äº‹ä»¶ç›‘å¬å’Œå¯åŠ¨
    // ==========================================================

    // æ³¨å†Œ Service Worker (ç”¨äºç¦»çº¿åŠŸèƒ½) 
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js').then(registration => {
                console.log('SW registered: ', registration);
            }).catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
        });
    }

    // å¯åŠ¨é€»è¾‘ï¼šåŒæ­¥åˆå§‹åŒ–ä»»åŠ¡ï¼Œç„¶åå¯åŠ¨å®šä½
    window.onload = function() {
        const isLoaded = initializeMissions();
        if (isLoaded) {
            startGeolocation();
        }
    };

    document.getElementById('ar-button').addEventListener('click', startAR);
    
    document.getElementById('exit-ar-btn').addEventListener('click', function() {
        exitAR(false); 
    });

    document.getElementById('close-reward-btn').addEventListener('click', function() {
        document.getElementById('reward-card-overlay').style.display = 'none';
        exitAR(false);
    });
</script>

</body>
</html>
